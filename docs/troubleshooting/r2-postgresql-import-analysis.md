# R2 to PostgreSQL Import Analysis

**Date:** November 18, 2025  
**Analyzed By:** GitHub Copilot

## Issue Summary

The user encountered a Git push error when trying to push their repository to GitHub due to the repository size being too large (6.08 GiB). This was caused by the `start/` directory containing audio files being tracked by Git.

## Root Cause

The `start/elmify-audio/` directory contains:
- 8 speakers
- 12 collections  
- 467 audio lecture files
- Images (speaker photos, collection covers)

This directory was being tracked by Git, causing the repository to exceed GitHub's size limits.

## Solution Applied

1. **Removed `start/` from Git tracking:**
   ```bash
   git rm -r --cached start/
   git commit -m "Remove start/ directory from git tracking"
   ```

2. **Ensured `.gitignore` contains:**
   ```
   start/
   ```

## R2 Import Workflow

The user has two scripts to import R2 data into PostgreSQL:

### 1. Manifest Generation: `import_build_R2_manifest_json.js`

**Purpose:** Scans R2 bucket and creates a JSON manifest.

**Usage:**
```bash
node import_build_R2_manifest_json.js \
  --endpoint https://xxx.r2.cloudflarestorage.com \
  --access-key YOUR_KEY \
  --secret-key YOUR_SECRET \
  --bucket elmify-audio \
  --output r2_manifest_1.json
```

**What it does:**
- Lists all objects in R2 bucket
- Parses folder structure: `Speaker/Collection/lecture.mp3`
- Reads metadata from `speaker.json` and `collection.json` files
- Generates a JSON manifest with all data

**Output:** `r2_manifest_1.json` containing:
- 8 speakers with bios and images
- 12 collections with descriptions and cover images
- 467 lectures with metadata

### 2. Database Import: `import_manifest.js`

**Purpose:** Imports the JSON manifest into PostgreSQL.

**Usage:**
```bash
# For Railway (production)
DATABASE_URL="postgresql://user:pass@host:port/db" \
  node import_manifest.js r2_manifest_1.json

# For local development
node import_manifest.js r2_manifest_1.json
```

**What it does:**
- Reads the JSON manifest
- Connects to PostgreSQL (Railway or local)
- Inserts/updates speakers, collections, and lectures
- Uses `ON CONFLICT` to handle duplicates

## Compatibility Analysis

### Database Schema

The PostgreSQL schema (from Flyway migrations) has:

**Speakers table:**
```sql
CREATE TABLE speakers (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  bio TEXT,                          -- Added in V11
  image_url TEXT,
  image_small_url TEXT,
  is_premium BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**Collections table:**
```sql
CREATE TABLE collections (
  id BIGSERIAL PRIMARY KEY,
  speaker_id BIGINT REFERENCES speakers(id),
  title TEXT NOT NULL,
  description TEXT,                  -- Added in V11
  year INTEGER,
  cover_image_url TEXT,
  cover_image_small_url TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(speaker_id, title)
);
```

**Lectures table:**
```sql
CREATE TABLE lectures (
  id BIGSERIAL PRIMARY KEY,
  collection_id BIGINT REFERENCES collections(id),
  title TEXT NOT NULL,
  description TEXT,
  lecture_number INTEGER,
  file_name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  duration INTEGER,
  file_size BIGINT,
  file_format TEXT,
  bitrate INTEGER,
  sample_rate INTEGER,
  file_hash TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### JSON Manifest Structure

The manifest generated by `import_build_R2_manifest_json.js` has:

```json
{
  "speakers": [
    {
      "name": "Abdul Rashid Sufi",
      "bio": "...",
      "imageUrl": "Abdul Rashid Sufi/speaker.jpg",
      "imageSmallUrl": "Abdul Rashid Sufi/speaker_small.jpg",
      "isPremium": false,
      "collections": [
        {
          "title": "Quran Hafs",
          "description": "...",
          "year": 2025,
          "coverImageUrl": "Abdul Rashid Sufi/Quran Hafs/collection.jpg",
          "coverImageSmallUrl": "Abdul Rashid Sufi/Quran Hafs/collection_small.jpg",
          "lectures": [
            {
              "title": "Al-Fatiha (The opener)",
              "description": null,
              "lectureNumber": 1,
              "fileName": "01 - Al-Fatiha (The opener).mp3",
              "filePath": "Abdul Rashid Sufi/Quran Hafs/01 - Al-Fatiha (The opener).mp3",
              "duration": 0,
              "fileSize": 822358,
              "fileFormat": "mp3"
            }
          ]
        }
      ]
    }
  ]
}
```

### Field Mapping

| JSON Field | Import Script | Database Column | Status |
|------------|---------------|-----------------|--------|
| `name` | âœ… `speakerData.name` | `speakers.name` | âœ… Compatible |
| `bio` | âœ… `speakerData.bio` | `speakers.bio` | âœ… Compatible |
| `imageUrl` | âœ… `speakerData.imageUrl` | `speakers.image_url` | âœ… Compatible |
| `imageSmallUrl` | âœ… `speakerData.imageSmallUrl` | `speakers.image_small_url` | âœ… Compatible |
| `isPremium` | âœ… `speakerData.isPremium` | `speakers.is_premium` | âœ… Compatible |
| `title` | âœ… `collectionData.title` | `collections.title` | âœ… Compatible |
| `description` | âœ… `collectionData.description` | `collections.description` | âœ… Compatible |
| `year` | âœ… `collectionData.year` | `collections.year` | âœ… Compatible |
| `coverImageUrl` | âœ… `collectionData.coverImageUrl` | `collections.cover_image_url` | âœ… Compatible |
| `coverImageSmallUrl` | âœ… `collectionData.coverImageSmallUrl` | `collections.cover_image_small_url` | âœ… **FIXED** |

### Issue Found and Fixed

**Problem:** The manifest generation script was using `coverImageSmall` instead of `coverImageSmallUrl`.

**Root Cause:** Line 337 in `import_build_R2_manifest_json.js` was generating the wrong field name:
```javascript
// âŒ WRONG
coverImageSmall: data.coverImageSmall || null,
```

**Fix Applied:** Updated `import_build_R2_manifest_json.js` line 337:
```javascript
// âœ… CORRECT
coverImageSmallUrl: data.coverImageSmall || null,
```

**Why it matters:** The backend DTOs (`CollectionDto.java`) expect `coverImageSmallUrl` for API responses to the frontend.

## URL Handling

**Important:** The application stores **relative R2 paths** in the database, NOT full URLs.

**Example:**
- âœ… Stored in DB: `Abdul Rashid Sufi/speaker.jpg`
- âŒ NOT stored: `https://cdn.elmify.com/Abdul Rashid Sufi/speaker.jpg`

**Why?** The `StorageService` generates presigned URLs dynamically at runtime:
```java
// From SpeakerDto.java
private static String toPresignedUrl(String path, StorageService storageService) {
    // Convert relative path to presigned URL
    return storageService.generatePresignedUrl(path);
}
```

**Benefits:**
- Presigned URLs can expire (security)
- Can switch storage backends without DB migration
- Reduces DB storage size

## Import Process

### Step 1: Generate Manifest

```bash
cd scripts
node import_build_R2_manifest_json.js \
  --endpoint https://b995be98e08909685abfca00c971e79e.r2.cloudflarestorage.com \
  --access-key 6646304addff312b15ccdba7e29192be \
  --secret-key 2cc74d235d9977c093a6fc938bee4a576c42640050d35a357ab037d8bd56c7c0 \
  --bucket elmify-audio \
  --output r2_manifest_1.json
```

**Output:**
```
âœ… Total: 532 objects in R2
âœ… Found 8 speakers
âœ… 12 collections
âœ… 467 lectures
ðŸ“ Saved to: r2_manifest_1.json
```

### Step 2: Review Manifest (Optional)

```bash
cat r2_manifest_1.json | jq '.speakers[] | {name, collections: .collections | length}'
```

### Step 3: Import to PostgreSQL

**For Railway:**
```bash
# Get DATABASE_URL from Railway dashboard
DATABASE_URL="postgresql://postgres:xxx@xxx.railway.app:5432/railway" \
  node import_manifest.js r2_manifest_fixed.json
```

**For Local Development:**
```bash
# Uses config from application-dev.yml
node import_manifest.js r2_manifest_fixed.json
```

**Output:**
```
ðŸ“ Reading manifest: r2_manifest_1.json
ðŸ“Š Found 8 speakers
âœ… Connected to database

ðŸ“¢ Processing speaker: Abdul Rashid Sufi
  âœ… Speaker ID: 1
  ðŸ“š Processing collection: Quran Hafs
    âœ… Collection ID: 1
    ðŸŽµ Processing lecture: Al-Fatiha (The opener)
      âœ… Lecture imported
    ...

==================================================
âœ… Import complete!
==================================================
ðŸ“Š Summary:
   Speakers:    8
   Collections: 12
   Lectures:    467
==================================================
```

## Flyway Integration

The application uses Flyway for database migrations. When deployed to Railway:

1. Flyway runs all `V*.sql` files in order
2. Database schema is created/updated automatically
3. Application starts and connects to the database

**From `application-dev.yml`:**
```yaml
spring:
  flyway:
    enabled: true
    baseline-on-migrate: true  # Useful if you have an existing database
    locations: classpath:db/migration
```

**What `baseline-on-migrate: true` means:**
- If the database already has data, Flyway won't fail
- It creates a baseline version and runs migrations from there
- Useful for development where you might already have test data

## Common PostgreSQL Commands

When connected to Railway PostgreSQL:

```bash
# Connect to Railway PostgreSQL
railway connect postgres

# Or use psql directly
psql "postgresql://postgres:xxx@xxx.railway.app:5432/railway"
```

**Inside psql:**
```sql
-- List all tables
\dt

-- Show table schema
\d speakers
\d collections
\d lectures

-- Count records
SELECT COUNT(*) FROM speakers;
SELECT COUNT(*) FROM collections;
SELECT COUNT(*) FROM lectures;

-- View speakers with collection count
SELECT s.name, COUNT(c.id) as collection_count
FROM speakers s
LEFT JOIN collections c ON s.id = c.speaker_id
GROUP BY s.id, s.name
ORDER BY s.name;

-- View data
SELECT * FROM speakers LIMIT 5;
SELECT * FROM collections WHERE speaker_id = 1;
SELECT * FROM lectures WHERE collection_id = 1 LIMIT 10;

-- Exit
\q
```

## Files Modified/Created

### Created:
- âœ… `scripts/import_manifest.js` - Database import script
- âœ… `docs/troubleshooting/r2-postgresql-import-analysis.md` - This document

### Modified:
- âœ… `scripts/import_build_R2_manifest_json.js` - Fixed argument parsing AND field name (`coverImageSmall` â†’ `coverImageSmallUrl`)

### Generated:
- âœ… `scripts/r2_manifest_1.json` - Original manifest (has wrong field name)
- âœ… `scripts/r2_manifest_fixed.json` - Corrected manifest (8 speakers, 12 collections, 467 lectures) **â† Use this one!**

## Next Steps

1. âœ… **Remove `start/` from Git** - DONE
2. âœ… **Generate R2 manifest** - DONE (`r2_manifest_1.json`)
3. âœ… **Create import script** - DONE (`import_manifest.js`)
4. â³ **Import to Railway PostgreSQL** - Ready to run
5. â³ **Verify data in database** - Use psql commands above
6. â³ **Push to GitHub** - Should work now that `start/` is ignored
7. â³ **Deploy to Railway** - Automatic on git push

## Recommended Workflow

For future updates:

```bash
# 1. Update R2 bucket (upload new lectures/collections)

# 2. Regenerate manifest
cd scripts
node import_build_R2_manifest_json.js --output r2_manifest_$(date +%Y%m%d).json

# 3. Import to Railway
DATABASE_URL="..." node import_manifest.js r2_manifest_$(date +%Y%m%d).json

# 4. Verify
railway connect postgres
# Run SELECT queries to verify

# 5. Commit and push (only code changes, not audio files)
git add .
git commit -m "Update database from R2"
git push
```

## Troubleshooting

### "Error: Manifest file not found"
```bash
# Make sure you're in the scripts directory
cd scripts
ls -la r2_manifest_1.json
```

### "Connection refused" (PostgreSQL)
```bash
# Check DATABASE_URL is set correctly
echo $DATABASE_URL

# For Railway, get it from:
railway variables --json | grep DATABASE_URL
```

### "Duplicate key value violates unique constraint"
This is expected if running the import multiple times. The script uses `ON CONFLICT` to handle duplicates gracefully.

### "Column 'bio' does not exist"
Make sure Flyway migrations have run:
```sql
-- Check migration status
SELECT * FROM flyway_schema_history ORDER BY installed_rank;

-- Verify bio column exists
\d speakers
```

## Security Notes

âš ï¸ **Never commit to Git:**
- R2 credentials (`R2_ACCESS_KEY`, `R2_SECRET_KEY`)
- Database URLs (`DATABASE_URL`)
- Audio files (`start/` directory)

âœ… **Use environment variables:**
```bash
# Create .env file (already in .gitignore)
echo "R2_ENDPOINT=https://..." >> scripts/.env
echo "R2_ACCESS_KEY_ID=xxx" >> scripts/.env
echo "R2_SECRET_ACCESS_KEY=xxx" >> scripts/.env
```

## Summary

âœ… **Problem Solved:** Git repository too large  
âœ… **Solution:** Removed `start/` directory from tracking  
âœ… **R2 Integration:** Scripts created to import R2 data to PostgreSQL  
âœ… **Compatibility:** All fields match between JSON manifest and database schema  
âœ… **Ready to Deploy:** Can now push to GitHub and deploy to Railway  

---

**Questions? Issues?**
- Check Flyway migration files in `src/main/resources/db/migration/`
- Review `application-dev.yml` and `application-prod.yml` for configuration
- Run `railway logs` to see deployment logs

