# Production Environment Configuration

spring:
  datasource:
    url: ${DATABASE_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

    hikari:
      connection-timeout: 30000
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
  
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

  jpa:
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        jdbc:
          batch_size: 50
        cache:
          use_second_level_cache: false
          use_query_cache: false
  
  flyway:
    enabled: true
    clean-disabled: true
    validate-on-migrate: false
    ignore-missing-migrations: true

  lifecycle:
    timeout-per-shutdown-phase: 20s

# Production server configuration
server:
  port: ${PORT:8080}
  max-http-header-size: 8KB
  tomcat:
    max-threads: 200
    min-spare-threads: 10
    connection-timeout: 20000
    max-swallow-size: 2MB
    threads:
      max: 200
      min-spare: 10
  compression:
    enabled: true
  forward-headers-strategy: framework
  shutdown: graceful

# Production logging
logging:
  level:
    root: WARN
    com.elmify: INFO
    org.springframework.security: WARN
    org.springframework.boot.web.embedded.tomcat: INFO
    org.springframework.web: INFO
    org.flywaydb: INFO
  pattern:
    console: "%d{ISO8601} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n"
  file:
    name: /var/log/elmify/application.log
    max-size: 100MB
    max-history: 30

# Disable Swagger in production for security
springdoc:
  api-docs:
    enabled: false
  swagger-ui:
    enabled: false

# Production-specific configuration
elmify:
  security:
    rate-limiting:
      enabled: true

  cors:
    # Production: Only allow your actual domain(s)
    # UPDATE THIS before deployment!
    allowed-origins: ${CORS_ALLOWED_ORIGINS:https://yourdomain.com,https://www.yourdomain.com}

  r2:
    endpoint: ${R2_ENDPOINT:https://b995be98e08909685abfca00c971e79e.r2.cloudflarestorage.com}
    bucket-name: ${R2_BUCKET_NAME:elmify-audio}
    access-key: ${R2_ACCESS_KEY}
    secret-key: ${R2_SECRET_KEY}
    region: ${R2_REGION:auto}
    presigned-url-expiration: PT6H  # 6 hours (allows for long lectures without URL expiration)

  clerk:
    secret-key: ${CLERK_SECRET_KEY}
    publishable-key: ${CLERK_PUBLISHABLE_KEY}
    jwt-issuer: ${CLERK_JWT_ISSUER}
# Production monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: never
      probes:
        enabled: true
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
        step: PT1M